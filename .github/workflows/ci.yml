# =============================================================================
# Nova VTU - CI/CD Pipeline
# Runs tests, checks migrations, and deploys on push to main
# =============================================================================

name: CI/CD Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  PYTHON_VERSION: "3.13"
  POSTGRES_DB: nova_vtu_test
  POSTGRES_USER: nova_vtu
  POSTGRES_PASSWORD: test_password

jobs:
  # ---------------------------------------------------------------------------
  # Lint and Type Check
  # ---------------------------------------------------------------------------
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies
        run: |
          uv sync --frozen
          uv sync --extra dev

      - name: Run ruff linter
        run: uv run ruff check .

      - name: Run ruff formatter check
        run: uv run ruff format --check .

  # ---------------------------------------------------------------------------
  # Test Suite
  # ---------------------------------------------------------------------------
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U nova_vtu -d nova_vtu_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies
        run: uv sync --frozen

      - name: Run tests
        env:
          DATABASE_URL: postgresql://${{ env.POSTGRES_USER }}:${{ env.POSTGRES_PASSWORD }}@localhost:5432/${{ env.POSTGRES_DB }}
          SECRET_KEY: test-secret-key-for-ci
          DEBUG: "False"
          PAYSTACK_SECRET_KEY: sk_test_fake
          PAYSTACK_PUBLIC_KEY: pk_test_fake
          VTPASS_API_KEY: fake-api-key
          VTPASS_PUBLIC_KEY: fake-public-key
          VTPASS_SECRET_KEY: fake-secret-key
          VTPASS_BASE_URL: https://sandbox.vtpass.com/api
        run: |
          uv run python manage.py test --verbosity=2

  # ---------------------------------------------------------------------------
  # Migration Checks
  # ---------------------------------------------------------------------------
  migrations:
    name: Check Migrations
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U nova_vtu -d nova_vtu_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies
        run: uv sync --frozen

      - name: Check for missing migrations
        env:
          DATABASE_URL: postgresql://${{ env.POSTGRES_USER }}:${{ env.POSTGRES_PASSWORD }}@localhost:5432/${{ env.POSTGRES_DB }}
          SECRET_KEY: test-secret-key-for-ci
          DEBUG: "False"
        run: |
          uv run python manage.py makemigrations --check --dry-run
          echo "âœ… No missing migrations detected"

      - name: Verify migrations can be applied
        env:
          DATABASE_URL: postgresql://${{ env.POSTGRES_USER }}:${{ env.POSTGRES_PASSWORD }}@localhost:5432/${{ env.POSTGRES_DB }}
          SECRET_KEY: test-secret-key-for-ci
          DEBUG: "False"
        run: |
          uv run python manage.py migrate --plan
          uv run python manage.py migrate
          echo "âœ… All migrations applied successfully"

      - name: Check for migration conflicts
        env:
          DATABASE_URL: postgresql://${{ env.POSTGRES_USER }}:${{ env.POSTGRES_PASSWORD }}@localhost:5432/${{ env.POSTGRES_DB }}
          SECRET_KEY: test-secret-key-for-ci
          DEBUG: "False"
        run: |
          # Check if there are any migration conflicts (multiple leaf migrations)
          if uv run python manage.py showmigrations | grep -E "^\s*\[\s*\]"; then
            echo "âš ï¸ Warning: Found unapplied migrations"
          fi
          echo "âœ… No migration conflicts detected"

  # ---------------------------------------------------------------------------
  # Security Check
  # ---------------------------------------------------------------------------
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies
        run: uv sync --frozen

      - name: Run Django security check
        env:
          SECRET_KEY: test-secret-key-for-ci
          DEBUG: "False"
        run: |
          uv run python manage.py check --deploy 2>&1 || true
          echo "âš ï¸ Review security warnings above before deploying"

  # ---------------------------------------------------------------------------
  # Build Docker Image
  # ---------------------------------------------------------------------------
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [lint, test, migrations]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: nova-vtu:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ---------------------------------------------------------------------------
  # Deploy to Production (only on main/master push)
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, security]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Deploy notification
        run: |
          echo "ðŸš€ Deployment triggered for commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "To complete deployment, configure the following secrets:"
          echo "  - SSH_HOST: Production server hostname"
          echo "  - SSH_USER: SSH username"
          echo "  - SSH_PRIVATE_KEY: SSH private key"
          echo ""
          echo "Then uncomment the deployment steps below."

      # Uncomment the following steps when ready to deploy:
      #
      # - name: Setup SSH
      #   uses: webfactory/ssh-agent@v0.8.0
      #   with:
      #     ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      #
      # - name: Add host key
      #   run: |
      #     mkdir -p ~/.ssh
      #     ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
      #
      # - name: Pre-deployment backup
      #   run: |
      #     ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
      #       cd /opt/nova-vtu
      #       docker compose --profile backup up -d backup
      #       docker exec nova-vtu-backup /scripts/backup.sh
      #       echo "âœ… Pre-deployment backup completed"
      #     EOF
      #
      # - name: Deploy application
      #   run: |
      #     ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
      #       cd /opt/nova-vtu
      #
      #       # Pull latest changes
      #       git pull origin main
      #
      #       # Build and restart containers
      #       docker compose build web
      #       docker compose up -d web
      #
      #       # Run migrations
      #       docker exec nova-vtu-web python manage.py migrate --noinput
      #
      #       # Collect static files
      #       docker exec nova-vtu-web python manage.py collectstatic --noinput
      #
      #       # Health check
      #       sleep 10
      #       curl -f http://localhost:8000/health/ || exit 1
      #
      #       echo "âœ… Deployment completed successfully"
      #     EOF
      #
      # - name: Notify on failure
      #   if: failure()
      #   run: |
      #     echo "âŒ Deployment failed! Check logs above."
      #     # Add Slack/Discord/Email notification here
